

#####################################################################
# Подключаемые модули
#####################################################################
[include mainsail.cfg]
[include timelapse.cfg]            # Конфигурация таймлапсов
[include offmodule.cfg]             # Модуль включения и выключения
[include led.cfg]                   # Макросы освещения области печати
[include start_end.cfg]                   # Макросы освещения области печати
[include stealthchanger/toolchanger-include.cfg]
[include motor_sync.cfg]                   # Макросы освещения области печати
[include speed_test.cfg]


#####################################################################
# 	                          Подключение MCU
#####################################################################
# Подключаем основную плату MKS8
[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32h723xx_46001D000D51333235363331-if00
#--------------------------------------------------------------------

[virtual_sdcard]
path: ~/printer_data/gcodes         # Путь, указывающий, где будут храниться файлы Gcode
#####################################################################
#                     Контроль температуры MCU
#####################################################################


# Температура хоста (OrangePi)
[temperature_sensor Host]
sensor_type: temperature_host
#sensor_path: /sys/class/thermal/thermal_zone0/temp
min_temp: -50
max_temp: 100
#####################################################################
#             Основные настройки кинематики принтера
#####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000
max_z_velocity: 200
max_z_accel: 350
square_corner_velocity: 5.0


#####################################################################
#                     Настройки оси X
#####################################################################
## Драйвер оси X
[stepper_x]
step_pin: PE5                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin: !PA8                       # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PA15                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation:200         # Количество шагов для полного оборота вала двигателя
endstop_pin: PD9                    # PIN, на котором находится концевик оси X
position_min: 0                     # Минимальное положение головы на оси X
position_endstop: 405               # Положение головы, при котором срабатывает концевой выключатель на оси X
position_max: 405                   # Максимальное положение головы на оси X
homing_speed: 150                   # Скорость движения при поиске дома
homing_retract_dist: 5              # Откат (возврат) после нахождения концевого выключателя, в мм.
homing_positive_dir: true           # Направление движения головы по оси X при поиске дома. Если true, голова будет двгигаться к
                                    # к максимальной позиции, если false - к минимальной (в 0)
#--------------------------------------------------------------------
[tmc2209 stepper_x]
uart_pin: PC9                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1                      # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

# #--------------------------------------------------------------------

##Драйвер оси X_1
[stepper_x1]
step_pin: PE8                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PE12                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PE11                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя

[tmc2209 stepper_x1]
uart_pin: PC15                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1                      # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#####################################################################
#                  Настройки оси Y
#####################################################################
[stepper_y]
step_pin: PE4                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin: !PC11                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PC12                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation:200         # Количество шагов для полного оборота вала двигателя
endstop_pin: PD8                    # PIN, на котором находится концевик оси Y
position_min: 0                     # Минимальное положение головы на оси Y
position_endstop: 550               # Положение головы, при котором срабатывает концевой выключатель на оси X
position_max: 550                   # Максимальное положение головы на оси X
homing_speed: 150                   # Скорость движения при поиске дома
homing_retract_dist: 5              # Откат (возврат) после нахождения концевого выключателя, в мм.
homing_positive_dir: true           # Направление движения головы по оси X при поиске дома. Если true, голова будет двгигаться к
                                    # к максимальной позиции, если false - к минимальной (в 0)
#--------------------------------------------------------------------
[tmc2209 stepper_y]
uart_pin: PC10                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1                      # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
# #--------------------------------------------------------------------


##Драйвер оси Y_1
[stepper_y1]
step_pin: PE9                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PC4                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PA7                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя

[tmc2209 stepper_y1]
uart_pin: PE10                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1                      # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#####################################################################
#                           Настройки оси Z
#####################################################################
[stepper_z]
step_pin:  PE3                      # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PD1                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PD2                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
# endstop_pin: sb2040:gpio18        # PIN, на котором находится концевик оси Z
endstop_pin: probe:z_virtual_endstop
position_max: 385                   # Максимальное положение головы на оси Z
position_min: -5                    # Минимальное положение головы на оси Z
homing_speed: 10                    # Скорость движения при поиске дома
second_homing_speed: 3              # Скорость движения при повторном измерении 0 (обычно меньше для увеличения точности)
homing_retract_dist: 0              # Откат (возврат) после нахождения концевого выключателя, в мм.
[tmc2209 stepper_z]
uart_pin:  PD0                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
## Двигатель Z1
[stepper_z1]
step_pin:   PE2                     # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:   PD4                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PD5                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z1]
uart_pin: PD3                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
##	Двигатель Z2
[stepper_z2]
step_pin: PE1                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:   !PD7                     # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PB6                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z2]
uart_pin: PD6                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
##	Двигатель Z3
[stepper_z3]
step_pin: PE0                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  PC13                       # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PC14                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z3]
uart_pin: PB7                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110


#####################################################################
#                   Настройка подогреваемого стола
#####################################################################
[heater_bed]
heater_pin: PB1                    # PIN управления нагревателем стола
sensor_type: EPCOS 100K B57560G104F   # Тип датчика температуры
sensor_pin: PB0                     # PIN датчика температуры
max_power: 1.0                      # Максимальная мощность, которую можно подать на стол. 1 соответствует 100% мощности
min_temp: -70                       # Минимальная температура стола. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 120                       # Максимальная температура стола. Если температура превысит данное значения, система выдаст ошибку.

######################## Вентиляторы Nevermore ########################
[duplicate_pin_override]
pins: PB0                          # Указываем Klipper, что будем повторно использовать значения PIN температуры подогреваемого стола
[temperature_fan Nevermore Fan]
pin: PD12                            # PIN управления вентиляторами Nevermore
max_power: 1                        # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
shutdown_speed: 0.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.
kick_start_time: 5.0                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
                                    # Значение по умолчанию равно 0,100 секунды.
sensor_type: EPCOS 100K B57560G104F # Тип датчика температуры
sensor_pin:  PB0                    # PIN датчика температуры
min_temp: -70                       # Минимальная температура стола. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 130                       # Максимальная температура стола. Если температура превысит данное значения, система выдаст ошибку.
target_temp: 90                    # Температура, которую будет пытаться достичь Nevermore. Так как мы используем значения температуры стола, то
                                    # по сути это температура стола, при которой будет включаться Nevermore
gcode_id: A
control: watermark


########################  Вентиляторы отсека аппаратуры #########################
[temperature_fan Electrical_cabinet Fan]
pin: PA1                          # PIN управления вытяжным вентилятором
max_power: 1                        # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
shutdown_speed: 0.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.
kick_start_time: 5.0                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
sensor_type: temperature_mcu        # Тип датчика температуры
min_temp: -70                       # Минимальная температура в хост-компьютера. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 100                       # Максимальная температура в хост-компьютера. Если температура превысит данное значения, система выдаст ошибку.
target_temp: 15                     # Температура хост-компьютера по умолчанию, при достижении которой будет включаться вытяжной вентилятор.
gcode_id: D
control: watermark

#####################################################################
#	          Управление подсветкой печатной камеры
#####################################################################
[neopixel Print_Area_LED]
pin: PA4                            # PIN управления подстветкой
chain_count: 50                     # Количество светодиодов в цепочке подсветки
color_order: GRB                    # Тип светодиодной ленты
initial_RED: 1                      # Первичное значение красного цвета
initial_GREEN: 1                    # Первичное значение зелёного цвета
initial_BLUE: 1                     # Первичное значение синего цвета


#####################################################################
#                          Таймаут принтера
#####################################################################
[idle_timeout]
timeout: 38800                      # Время простоя принтера, при превышении которого принтер сбрасывает текущие задачи. В секундах.

    

#####################################################################
# 	                  Построение карты стола
#####################################################################
[bed_mesh]
speed: 250                          # Скорость перемещения по оси X и Y при построении карты стола
horizontal_move_z: 2               # Высота, на которую будет подниматься ось Z при перемещении для построения карты
mesh_min: 30, 160                    # Точки с минимальными коородинатами x，y которые будет измерены
mesh_max: 375,510                   # Точки с максимальными коородинатами x，y которые будет измерены
fade_start: 0.6                     # На первых слоях голова начинает при своём движении учитывать карту стола и подниматься
                                    # опускаться относительно неё, что бы обеспечить ровные первые слои. Но начиная с
                                    # высоты fade_start принтер начнёт все меньше и меньше учитывать карту стола и плавно
                                    # переходить на ровное движение
fade_end: 10.0                      # Высота, при которой закончиться процесс выравнивания головы отностительно карты стола
fade_target: 0                      # Дополнительное смещение, которое останется после завершения выравнивания
probe_count: 5,5                 # Количество точек сетки стола по осям X и Y
mesh_pps: 2,3                       # Количество точек интерполяции
algorithm: bicubic                  # Алгоритм интерполяции
bicubic_tension: 0.2                # Натяжение интерполяции
zero_reference_position: 250, 207   # Центр измерения сетки
adaptive_margin: 1

#####################################################################
#                  Настройки выравнивания портала
#####################################################################

[quad_gantry_level]                 # Скорость перемещения по оси X и Y при выравнивании портала
gantry_corners:
	-60,-10
	410,610
points:
	30,160
	30,510
	375,510
	375,160
# --------------------------------------------------------------------
speed: 400                          # Скорость, с которой будет перемещаться голова при QGL
horizontal_move_z: 10               # Высота, на которую будет подниматься ось Z при перемещении для выравнивания портала
retry_tolerance: 0.01               # Точность измерения, которая должна быть получена. Если точность ниже, система выдаст ошибку.
retries: 5                          # Количество повторений измерения. Если после заданного количества
                                    # повторений не будет достигнута заданная точность, система выдаст ошибку
max_adjust: 10                      # Количество повторений процесса выравнивания. Если после заданного количества
                                    # повторений не будет достигнута заданная точность, система выдаст ошибку
                                    
[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
    SAVE_GCODE_STATE NAME=STATE_QGL
    BED_MESH_CLEAR
    {% if not printer.quad_gantry_level.applied %}
    _QUAD_GANTRY_LEVEL horizontal_move_z=10 retry_tolerance=1
    {% endif %}
    _QUAD_GANTRY_LEVEL horizontal_move_z=2 METHOD=rapid_scan ADAPTIVE=1
    # G28 Z
    RESTORE_GCODE_STATE NAME=STATE_QGL


#####################################################################
#                Настройка движения по кривым
#####################################################################
[gcode_arcs]                        # Подключение механизма движения по кривым линиям
resolution: 0.05                    # Точность при движении по кривым в командах G2，G3
                                    # Кривая будет разделена на несколько сегментов. Длина каждого сегмента будет равна
                                    # указанному разрешению (в мм). Более низкие значения позволят получить более
                                    # точные кривые, но при этом сущетсвенно увеличивают нагрузку на процессор вашего принтера.
                                    # Если дуга меньше заданного значения, она превратится в прямую линию.
                                    # Значение по умолчанию - 1 мм.
#####################################################################
#          Возможность исключать объекты во время печати
#####################################################################
[exclude_object]

[resonance_tester]
accel_chip: lis2dw
probe_points:
   200,275,20                                              # Координаты по X, Y и Z, в которых будет производиться измерение
min_freq: 5
max_freq: 133
accel_per_hz: 75
hz_per_sec: 1 

[input_shaper]


[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.




[force_move]
enable_force_move: True
#   Set to true to enable FORCE_MOVE and SET_KINEMATIC_POSITION
#   extended G-Code commands. The default is false.

[rounded_path]
resolution: 0.2 # the length of a circle approximation segments.
replace_g0: False # Use at your own risk


# #####################################################################
# #          загрубление температуры экструдеров
# #####################################################################


# [gcode_macro M109]
# rename_existing: M109.1
# description: [T<index>] [S<temperature>]
#   Set tool temperature and wait.
#   T= Tool number, optional. If this parameter is not provided, the current tool is used.
#   S= Target temperature
# gcode:
#   {% if params.T is defined %}    
#     {% set aExtruder = "extruder" ~ (params.T if params.T != '0' else "") %}
#   {% else %}
#     {% set activeToolNumber = printer.tool_probe_endstop.active_tool_number|int %} 
#     {% if activeToolNumber == -1 %}
#       RESPOND TYPE=error MSG='Failed to detect active tool'
#       PAUSE
#     {% endif %}
#     {% set aExtruder = "extruder" ~ (activeToolNumber if activeToolNumber != 0 else "") %}
#   {% endif %}
#   {% if params.S is defined %}
#     {% set temp = params.S|float %}
#     M104 {rawparams}
#     {% if temp > 100 %}
#       TEMPERATURE_WAIT SENSOR={aExtruder} MINIMUM={temp-1} MAXIMUM={temp+1}
#     {% endif %}
#   {% else %}
#     M104 {rawparams}
#   {% endif %}


#####################################################################
#                     Служебные данные и настройки
#####################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 62.615
#*# pid_ki = 3.479
#*# pid_kd = 281.770
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.063541, 0.028959, 0.081459, 0.066459, -0.051041
#*# 	  -0.131041, -0.111041, -0.078541, -0.053541, -0.063541
#*# 	  -0.181041, -0.061041, -0.028541, -0.096041, -0.113541
#*# 	  -0.143541, -0.008541, -0.066041, -0.068541, -0.033541
#*# 	  -0.068541, -0.038541, 0.043959, 0.126459, -0.053541
#*# tension = 0.2
#*# min_x = 30.0
#*# algo = bicubic
#*# y_count = 5
#*# mesh_y_pps = 3
#*# min_y = 160.0
#*# x_count = 5
#*# max_y = 510.0
#*# mesh_x_pps = 2
#*# max_x = 375.0
#*#
#*# [tool T1]
#*# gcode_x_offset = 0.100000
#*# gcode_y_offset = 0.240625
#*# gcode_z_offset = 0.258750
#*#
#*# [tool T2]
#*# gcode_x_offset = -0.001563
#*# gcode_y_offset = 0.295312
#*# gcode_z_offset = -0.145000
#*#
#*# [tool T3]
#*# gcode_x_offset = 0.448437
#*# gcode_y_offset = 0.337500
#*# gcode_z_offset = -0.053750
#*#
#*# [tool T4]
#*# gcode_x_offset = 0.123437
#*# gcode_y_offset = 0.106250
#*# gcode_z_offset = 0.160000
#*#
#*# [tool T5]
#*# gcode_x_offset = 0.075000
#*# gcode_y_offset = 0.450000
#*# gcode_z_offset = 0.062500
#*#
#*# [motors_sync]
#*# steps_model_x = exponential,
#*# 	25045.044475386967,
#*# 	0.06870771084419772,
#*# 	-24882.25060443605
#*# steps_model_y = exponential,
#*# 	25045.044475386967,
#*# 	0.06870771084419772,
#*# 	-24882.25060443605
