[respond]

#####################################################################
# Подключаемые модули
#####################################################################
[include mainsail.cfg]

[include timelapse.cfg]             # Конфигурация таймлапсов
[include nozzle_scrub.cfg]          # Очистка сопла
[include stealthburner_leds.cfg]    # Подсветка StealthBurner
[include offmodule.cfg]             # Модуль включения и выключения
# [include filament_sensor.cfg]       # Датчик филамента
[include adxl345.cfg]               # Настройка датчика измерения резонансов
[include led.cfg]                   # Макросы освещения области печати
[include start_end.cfg]             # Макросы начала и окончания печати
[include speed_test.cfg]            # Макрос тестирования скоростей и ускорений
[include motors_sync.cfg]           #Конфигурация синхронизации моторов

#####################################################################
# 	                          Подключение MCU
#####################################################################
# Подключаем основную плату X10Pro
[mcu]
canbus_uuid: 740b70f29c09

#####################################################################
# 	                          Подключение Cartographer Probe
#####################################################################
[mcu cartographer]                  # Инструкция https://www.klipper3d.org/Config_Reference.html#mcu
canbus_uuid: 0bce71e31761

[cartographer]
mcu: cartographer
x_offset: 0                         # Это смещение от центра сопла к центру антенны датчика Cartographer по оси X
y_offset: 20                        # Это смещение от центра сопла к центру антенны датчика Cartographer по оси y
verbose: yes                        # Дополнительное отображение результатов в консоли

#--------------------------------------------------------------------

[virtual_sdcard]
path: ~/printer_data/gcodes         # Путь, указывающий, где будут храниться файлы Gcode
#####################################################################
#                     Контроль температуры MCU
#####################################################################

# Температура хоста (OrangePi)
[temperature_sensor Host]
sensor_type: temperature_host
#sensor_path: /sys/class/thermal/thermal_zone0/temp
min_temp: -50
max_temp: 100

# Температура CAN платы в голове
[temperature_sensor Камера]
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
min_temp: 0
max_temp: 80

# Температура Cartographer Probe
[temperature_sensor cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105

#####################################################################
#             Основные настройки кинематики принтера
#####################################################################
[printer]
kinematics: corexy
max_velocity: 500
max_accel: 20000
max_z_velocity: 20
max_z_accel: 350
square_corner_velocity: 5.0

#####################################################################
#                     Настройки оси X
#####################################################################
## Драйвер оси X
[stepper_x]
step_pin: PE7                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PG11                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PG10                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation:200         # Количество шагов для полного оборота вала двигателя
endstop_pin: PG8                    # PIN, на котором находится концевик оси X
position_min: 0                     # Минимальное положение головы на оси X
position_endstop: 495               # Положение головы, при котором срабатывает концевой выключатель на оси X
position_max: 495                   # Максимальное положение головы на оси X
homing_speed: 180                   # Скорость движения при поиске дома
homing_retract_dist: 5              # Откат (возврат) после нахождения концевого выключателя, в мм.
homing_positive_dir: true           # Направление движения головы по оси X при поиске дома. Если true, голова будет двгигаться к
                                    # к максимальной позиции, если false - к минимальной (в 0)
#--------------------------------------------------------------------
[tmc2209 stepper_x]
uart_pin: PG12                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1.2                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#--------------------------------------------------------------------

##Драйвер оси X_1
[stepper_x1]
step_pin: PE1                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PB7                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PC13                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя

[tmc2209 stepper_x1]
uart_pin: PB6                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1.2                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110



#####################################################################
#                  Настройки оси Y
#####################################################################
[stepper_y]
step_pin: PE8                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin: PE14                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PE13                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation:200         # Количество шагов для полного оборота вала двигателя
endstop_pin: PG7                    # PIN, на котором находится концевик оси Y
position_min: 0                     # Минимальное положение головы на оси Y
position_endstop: 505               # Положение головы, при котором срабатывает концевой выключатель на оси X
position_max: 505                   # Максимальное положение головы на оси X
homing_speed: 180                   # Скорость движения при поиске дома
homing_retract_dist: 5              # Откат (возврат) после нахождения концевого выключателя, в мм.
homing_positive_dir: true           # Направление движения головы по оси X при поиске дома. Если true, голова будет двгигаться к
                                    # к максимальной позиции, если false - к минимальной (в 0)
#--------------------------------------------------------------------
[tmc2209 stepper_y]
uart_pin: PE15                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1.2                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#--------------------------------------------------------------------


##Драйвер оси Y_1
[stepper_y1]
step_pin: PE4                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  PC15                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PF0                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя

[tmc2209 stepper_y1]
uart_pin: PC14                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1.2                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#####################################################################
#                           Настройки оси Z
#####################################################################
## Двигатель Z0
[stepper_z]
step_pin:  PE9                      # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  PG1                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PG0                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
endstop_pin: probe:z_virtual_endstop
position_max: 480                   # Максимальное положение головы на оси Z
position_min: -5                    # Минимальное положение головы на оси Z
homing_speed: 10                    # Скорость движения при поиске дома
second_homing_speed: 3              # Скорость движения при повторном измерении 0 (обычно меньше для увеличения точности)
homing_retract_dist: 0              # Откат (возврат) после нахождения концевого выключателя, в мм.
[tmc2209 stepper_z]
uart_pin:  PE12                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
## Двигатель Z1
[stepper_z1]
step_pin:   PE10                     # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:   !PF14                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PF13                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z1]
uart_pin: PF15                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
##	Двигатель Z2
[stepper_z2]
step_pin: PE11                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:   PF11                     # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PB2                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z2]
uart_pin: PF12                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
##	Двигатель Z3
[stepper_z3]
step_pin: PE2                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  PF10                       # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PC0                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z3]
uart_pin: PF5                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#####################################################################
#                    Настройки хотэнда и экструдера
#####################################################################
[extruder]
step_pin: PE3              # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin: PF2             # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PF4           # PIN Включение двигателя.
rotation_distance: 4.69       # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation: 200        # Количество шагов для полного оборота вала двигателя
nozzle_diameter: 0.400              # Диаметр сопла, значение по умолчанию 0.4.
filament_diameter: 1.75             # Диаметр используемого пластика
heater_pin:  PF8           # PIN управления нагревателем хотэнда
sensor_type: PT1000    #Тип датчика температуры
sensor_pin: PC5           # PIN датчика температуры
min_temp: -20                       # Минимальная температура хотэнда. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 330                       # Максимальная температура хотэнда. Если температура превысит данное значения, система выдаст ошибку.
max_power: 1.0                      # Максимальная мощность, которую можно подать на хотэнд. 1 соответствует 100% мощности
min_extrude_temp: 170               # Минимальная температура, при которой возможна экструзия. Если хотэнд нагрет ниже, система выдаст ошибку и
                                    # мотор экструдера не будет вращаться
max_extrude_only_distance: 500      # Максимальное расстояние в мм, на которое можно выдавить пластик за один раз
max_extrude_cross_section: 50       # Максимальная площадь поперечного сечения экструзии (в мм^2) (например, ширина экструзии, умноженная на высоту слоя).
                                    # Эта настройка предотвращает чрезмерное выдавливание при относительно небольших перемещениях XY.
                                    # Если при перемещении требуется скорость экструзии, превышающая это значение, это приведет к возврату ошибки.
                                    # Значение по умолчанию равно: 4.0 * nozzle_diameter^2
#Для калибровки PID хотэнда выполните команду："PID_CALIBRATE HEATER=extruder TARGET=245"
#control = pid                      # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
#pid_kp = 26.213                    # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
#pid_ki = 1.304                     # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
#pid_kd = 131.721                   # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
pressure_advance: 0.025              # Параметр Pressure Advance, по умочанию 0.05
pressure_advance_smooth_time: 0.03    # Параметр сглаживания Pressure Advance, по умочанию 0.040
[tmc2209 extruder]
uart_pin: PF1                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
stealthchop_threshold: 0
driver_TBL: 0
driver_HEND: 6
driver_HSTRT: 7
driver_TOFF: 4
#####################################################################
[verify_heater extruder]            # Проверка нагревателя и датчика температуры.
max_error: 120                      # Максимальная "суммарная температурная погрешность" перед выдачей сообщения об ошибке.
                                    # Меньшие значения приводят к более строгой проверке, а большие значения позволяют увеличить время до
                                    # появления сообщения об ошибке. В частности, температура проверяется раз в секунду, и если
                                    # она близка к заданной температуре, то внутренний "счетчик ошибок" сбрасывается;
                                    # в противном случае, если температура ниже заданного диапазона, то счетчик увеличивается на величину,
                                    # на которую указанная температура отличается от этого диапазона.
                                    # Если значение счетчика превышает значение "max_error", выдается сообщение об ошибке.
                                    # Значение по умолчанию равно 120
check_gain_time:120                 # Это позволяет контролировать проверку нагревателя при первоначальном нагреве.
                                    # Меньшие значения приводят к более тщательной проверке, а большие значения позволяют увеличить время
                                    # до появления сообщения об ошибке. В частности, во время первоначального нагрева,
                                    # если температура нагревателя повышается в течение этого периода времени (указанного в секундах),
                                    # внутренний "счетчик ошибок" сбрасывается.
                                    # Значение по умолчанию равно 20 секундам для экструдеров и 60 секундам для нагревательного слоя.
hysteresis: 50                      # Максимальная разница температур (в градусах Цельсия) с заданной температурой,
                                    # которая считается в пределах заданного диапазона. Это позволяет проверить диапазон max_error.
                                    # Это значение редко настраивается. Значение по умолчанию равно 5.
heating_gain: 2                     # Минимальная температура (в градусах Цельсия), на которую должен быть увеличен нагреватель
                                    # во время проверки check_gain_time. Это значение редко настраивается. Значение по умолчанию равно 2.

#####################################################################
#                   Настройка подогреваемого стола
#####################################################################
[heater_bed]
heater_pin: PC7                    # PIN управления нагревателем стола
sensor_type: EPCOS 100K B57560G104F   # Тип датчика температуры
sensor_pin: PF3                     # PIN датчика температуры
max_power: 1.0                      # Максимальная мощность, которую можно подать на стол. 1 соответствует 100% мощности
min_temp: -70                       # Минимальная температура стола. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 120                       # Максимальная температура стола. Если температура превысит данное значения, система выдаст ошибку.
#####################################################################
#                       Вентиляторы охлаждения
#####################################################################

######################### Вентилятор охлаждения хотэнда ########################
[heater_fan Hotend]
pin: PA0                  # PIN управления вентилятором охлаждения хотэнда
max_power: 1.0                      # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
kick_start_time: 0.5                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
                                    # Значение по умолчанию равно 0,100 секунды.
heater: extruder
heater_temp: 50.0                   # Порог запуска вентилятора
fan_speed: 1                        # Позволяет регулировать скорость вентилятора, по умолчанию 1 - 100%
shutdown_speed: 1.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.

######################## Вентилятор обдува области печати ########################

[fan]
pin: PB11
enable_pin: PB10
hardware_pwm: False
max_power: 0.5
cycle_time: 0.000022
off_below: 0.15
kick_start_time: 0.01


######################## Вентиляторы Nevermore ########################
[duplicate_pin_override]
pins: PF3                          # Указываем Klipper, что будем повторно использовать значения PIN температуры подогреваемого стола
[temperature_fan Nevermore Fan]
pin: PE5                            # PIN управления вентиляторами Nevermore
max_power: 1                        # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
shutdown_speed: 0.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.
kick_start_time: 5.0                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
                                    # Значение по умолчанию равно 0,100 секунды.
sensor_type: EPCOS 100K B57560G104F # Тип датчика температуры
sensor_pin:  PF3                    # PIN датчика температуры
min_temp: -70                       # Минимальная температура стола. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 130                       # Максимальная температура стола. Если температура превысит данное значения, система выдаст ошибку.
target_temp: 90                    # Температура, которую будет пытаться достичь Nevermore. Так как мы используем значения температуры стола, то
                                    # по сути это температура стола, при которой будет включаться Nevermore
gcode_id: A
control: watermark

########################  Вытяжной вентилятор #########################
[fan_generic Exhaust]
pin:PA2
max_power: 1.0

########################  Вентиляторы отсека аппаратуры #########################
[temperature_fan Апп.Отсек Fan]
pin: PA15                          # PIN управления вытяжным вентилятором
max_power: 0.5                        # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
shutdown_speed: 0.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.
kick_start_time: 5.0                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
sensor_type: temperature_mcu        # Тип датчика температуры
min_temp: -70                       # Минимальная температура в хост-компьютера. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 100                       # Максимальная температура в хост-компьютера. Если температура превысит данное значения, система выдаст ошибку.
target_temp: 15                     # Температура хост-компьютера по умолчанию, при достижении которой будет включаться вытяжной вентилятор.
gcode_id: D
control: watermark

[temperature_fan MCU_FAN]
pin: PD12
#max_power:
shutdown_speed: 0.0
cycle_time: 0.000022
hardware_pwm: False
kick_start_time: 0.01
off_below: 0.15
tachometer_pin: PD15
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   Описание параметров выше см. в разделе "fan".
sensor_type: temperature_host
# sensor_pin: 
control: pid
#max_delta:
min_temp:-20
max_temp:100
target_temp: 50                     # Температура хост-компьютера по умолчанию, при достижении которой будет включаться вытяжной вентилятор.
#   Описание параметров выше см. в разделе "extruder".
pid_Kp:20
pid_Ki:4.0
pid_Kd:20
#   Настройки пропорционального (pid_Kp), интегрального (pid_Ki) и дифференциального
#   (pid_Kd) коэффициентов для системы ПИД-регулирования. Klipper вычисляет
#   управляющий сигнал по следующей общей формуле:
#     fan_pwm =

#####################################################################
#	          Управление подсветкой печатной камеры
#####################################################################
[neopixel Подсветка]
pin: PF9                            # PIN управления подстветкой
chain_count: 50                     # Количество светодиодов в цепочке подсветки
color_order: GRB                    # Тип светодиодной ленты
initial_RED: 1                      # Первичное значение красного цвета
initial_GREEN: 1                    # Первичное значение зелёного цвета
initial_BLUE: 1                     # Первичное значение синего цвета

#####################################################################
#                          Таймаут принтера
#####################################################################
[idle_timeout]
timeout: 38800                      # Время простоя принтера, при превышении которого принтер сбрасывает текущие задачи. В секундах.

#####################################################################
# 	                  Построение карты стола
#####################################################################
[bed_mesh]
speed: 400                          # Скорость перемещения по оси X и Y при построении карты стола
horizontal_move_z: 3               # Высота, на которую будет подниматься ось Z при перемещении для построения карты
mesh_min: 50, 50                    # Точки с минимальными коородинатами x，y которые будет измерены
mesh_max: 400,400                   # Точки с максимальными коородинатами x，y которые будет измерены
fade_start: 0.6                     # На первых слоях голова начинает при своём движении учитывать карту стола и подниматься
                                    # опускаться относительно неё, что бы обеспечить ровные первые слои. Но начиная с
                                    # высоты fade_start принтер начнёт все меньше и меньше учитывать карту стола и плавно
                                    # переходить на ровное движение
fade_end: 10.0                      # Высота, при которой закончиться процесс выравнивания головы отностительно карты стола
fade_target: 0                      # Дополнительное смещение, которое останется после завершения выравнивания
probe_count: 20,20                  # Количество точек сетки стола по осям X и Y
mesh_pps: 0,0                       # Количество точек интерполяции
algorithm: bicubic                  # Алгоритм интерполяции
zero_reference_position: 250, 250   # Центр измерения сетки
adaptive_margin: 10

#####################################################################
#                  Настройки выравнивания портала
#####################################################################

[homing_override]
axes: xyz
set_position_z: 10
gcode:
    {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
    {% set e_target = printer.extruder.target %} # Сохранить текущую температуру
    {% set fan_speed = printer.fan.speed %}      # Сохранить текущую скорость вентилятора
   
    G90                                          # Включаем абсолютные коордниаты                      
    G0 Z15 F600                                  # Поднимаем голову на 15 мм по Z, что бы не задеть стол
    
    {% if home_all or 'Y' in params %}
        G28 Y
    {% endif %}
    
    {% if home_all or 'X' in params %}
        G28 X
    {% endif %}

    {% if home_all or 'Z' in params %}
        G0 X{printer.toolhead.axis_maximum.x / 2} Y{printer.toolhead.axis_maximum.y / 2} F6000
        {% if e_target >= 150 or printer.extruder.temperature >= 150 %}
            M106 S255 # Включить вентилятор
            M109 S150 # Убедиться, что Z калибруется при температуре 150 градусов
        {% endif %}
        M106 S0       # Выключить вентилятор
        G28 Z 
        G1 Z10 F2000
  
        M109 S{e_target}  # Восстановить температуру
        M106 S{fan_speed} # Восстановить скорость вентилятора
    {% endif %}

[quad_gantry_level]                 # Скорость перемещения по оси X и Y при выравнивании портала
gantry_corners:
	-60,-10
	560,527
points:
	50,50
	50,400
	450,400
	450,50
#--------------------------------------------------------------------
speed: 400                          # Скорость, с которой будет перемещаться голова при QGL
horizontal_move_z: 10               # Высота, на которую будет подниматься ось Z при перемещении для выравнивания портала
retry_tolerance: 0.01               # Точность измерения, которая должна быть получена. Если точность ниже, система выдаст ошибку.
retries: 5                          # Количество повторений измерения. Если после заданного количества
                                    # повторений не будет достигнута заданная точность, система выдаст ошибку
max_adjust: 10                      # Количество повторений процесса выравнивания. Если после заданного количества
                                    # повторений не будет достигнута заданная точность, система выдаст ошибку
                                    
[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
    SAVE_GCODE_STATE NAME=STATE_QGL
    BED_MESH_CLEAR
    {% if not printer.quad_gantry_level.applied %}
    _QUAD_GANTRY_LEVEL horizontal_move_z=10 retry_tolerance=1
    {% endif %}
    _QUAD_GANTRY_LEVEL horizontal_move_z=2 METHOD=rapid_scan ADAPTIVE=1
    # G28 Z
    RESTORE_GCODE_STATE NAME=STATE_QGL

#####################################################################
#                Настройка движения по кривым
#####################################################################
[gcode_arcs]                        # Подключение механизма движения по кривым линиям
resolution: 0.1                    # Точность при движении по кривым в командах G2，G3
                                    # Кривая будет разделена на несколько сегментов. Длина каждого сегмента будет равна
                                    # указанному разрешению (в мм). Более низкие значения позволят получить более
                                    # точные кривые, но при этом сущетсвенно увеличивают нагрузку на процессор вашего принтера.
                                    # Если дуга меньше заданного значения, она превратится в прямую линию.
                                    # Значение по умолчанию - 0.1 мм.
#####################################################################
#          Возможность исключать объекты во время печати
#####################################################################
[exclude_object]

[firmware_retraction]
retract_length: 0.8
# Длина отката при G10 в мм, а так же длина подачи, возвращаемая при запуске G11
# (но она также включает в себя следующую unretract_extra_length). Значение по умолчанию равно 0 мм.
retract_speed: 35
#  Скорость ретракта в миллиметрах в секунду (мм/с), по умолчанию равна 20 мм/с.
unretract_extra_length: 0
# Дополнительная длина, добавляемая при подаче прутка после ретракта
unretract_speed: 35
# Скорость подачи после ретакта, в мм/с, по умолчанию 10мм/с

[gcode_macro M109]
rename_existing: M99109
gcode:
    # Parameters
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}   ; Wait for hotend temp (within 1 degree)
    {% endif %}	

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.
#####################################################################
#                     Служебные данные и настройки
#####################################################################

# [include AFC/*.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 59.334
#*# pid_ki = 2.805
#*# pid_kd = 313.731
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 42.307
#*# pid_ki = 12.263
#*# pid_kd = 36.490
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 104.2
#*# shaper_type_y = mzv
#*# shaper_freq_y = 65.6
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.028961, -0.017048, -0.001135, 0.003931, 0.008616, 0.012649, 0.006594, -0.004821, -0.011298, -0.020112, -0.028961, -0.043005, -0.046107, -0.047140, -0.047140, -0.041313, -0.038220, -0.035130, -0.039251, -0.033071
#*# 	-0.039251, -0.025231, -0.003165, 0.004942, 0.009624, 0.016680, 0.012280, 0.008616, -0.000306, -0.005193, -0.012963, -0.028120, -0.031390, -0.033257, -0.034101, -0.033071, -0.034101, -0.033071, -0.039251, -0.038220
#*# 	-0.037188, -0.024205, -0.006211, 0.000894, 0.004571, 0.009624, 0.006594, 0.006965, 0.006594, 0.002549, -0.003165, -0.015190, -0.025231, -0.026907, -0.035130, -0.034101, -0.041313, -0.039251, -0.051283, -0.051283
#*# 	-0.059592, -0.035130, -0.020112, -0.013337, -0.011298, -0.007228, -0.007228, -0.001135, -0.000120, -0.000120, -0.005193, -0.016026, -0.018068, -0.021136, -0.029989, -0.034101, -0.038877, -0.043005, -0.054397, -0.061677
#*# 	-0.067558, -0.048364, -0.035130, -0.029334, -0.028308, -0.023180, -0.023180, -0.017233, -0.015005, -0.017048, -0.020300, -0.027283, -0.029334, -0.029334, -0.038220, -0.047140, -0.050248, -0.053360, -0.067558, -0.076598
#*# 	-0.081845, -0.057514, -0.043192, -0.033071, -0.029147, -0.024020, -0.023180, -0.023180, -0.019276, -0.021136, -0.019089, -0.026257, -0.026907, -0.025231, -0.032044, -0.043005, -0.049213, -0.054209, -0.072596, -0.081845
#*# 	-0.086052, -0.060635, -0.045074, -0.039251, -0.028961, -0.017418, -0.017048, -0.017233, -0.014356, -0.015005, -0.010096, -0.019092, -0.027283, -0.030175, -0.033071, -0.039251, -0.053360, -0.067558, -0.085675, -0.096228
#*# 	-0.097285, -0.075927, -0.055434, -0.041313, -0.031017, -0.019464, -0.017048, -0.011298, -0.005193, -0.003349, -0.001507, -0.012963, -0.018068, -0.022158, -0.029334, -0.033071, -0.049213, -0.069645, -0.090945, -0.102580
#*# 	-0.097285, -0.079746, -0.059219, -0.051283, -0.039251, -0.021136, -0.019927, -0.012963, -0.005193, -0.002150, -0.001135, -0.012963, -0.018253, -0.020112, -0.031390, -0.041127, -0.051286, -0.071738, -0.102580, -0.114960
#*# 	-0.108573, -0.088157, -0.067558, -0.059219, -0.049213, -0.031390, -0.026907, -0.015190, -0.007228, -0.003165, 0.000522, -0.011298, -0.017418, -0.021136, -0.028961, -0.041313, -0.052322, -0.072784, -0.102580, -0.114960
#*# 	-0.108950, -0.096603, -0.073642, -0.057514, -0.049213, -0.036159, -0.028961, -0.015375, -0.005193, -0.001135, 0.002549, -0.010928, -0.019089, -0.024859, -0.034101, -0.045074, -0.057514, -0.075551, -0.101519, -0.117091
#*# 	-0.117091, -0.092376, -0.072596, -0.061303, -0.051283, -0.036159, -0.025231, -0.015005, -0.003165, -0.001135, 0.000894, -0.013150, -0.021136, -0.024859, -0.034101, -0.042161, -0.061303, -0.083949, -0.106822, -0.119225
#*# 	-0.119225, -0.099592, -0.078022, -0.057514, -0.050434, -0.035130, -0.029334, -0.018068, -0.008890, -0.007228, -0.006024, -0.017047, -0.025231, -0.031017, -0.037188, -0.051283, -0.065472, -0.094112, -0.119225, -0.135806
#*# 	-0.121360, -0.092002, -0.069645, -0.058553, -0.051283, -0.041313, -0.030362, -0.021136, -0.011298, -0.008059, -0.009077, -0.015375, -0.025231, -0.031390, -0.035130, -0.051283, -0.067558, -0.083950, -0.114960, -0.129739
#*# 	-0.113015, -0.092376, -0.079073, -0.066515, -0.055434, -0.037188, -0.031017, -0.024859, -0.015005, -0.013984, -0.013337, -0.019089, -0.028308, -0.033071, -0.035130, -0.045259, -0.060635, -0.081845, -0.108572, -0.133843
#*# 	-0.104701, -0.086052, -0.071549, -0.073642, -0.063758, -0.045074, -0.034101, -0.026907, -0.017048, -0.018068, -0.017418, -0.021136, -0.031203, -0.033071, -0.037188, -0.040282, -0.056288, -0.081845, -0.105573, -0.125642
#*# 	-0.101519, -0.077646, -0.069270, -0.067558, -0.061677, -0.040942, -0.029334, -0.015006, -0.011298, -0.016026, -0.019089, -0.021136, -0.024205, -0.030175, -0.039251, -0.043380, -0.059592, -0.083950, -0.102580, -0.129927
#*# 	-0.090268, -0.069645, -0.045074, -0.043192, -0.034287, -0.021136, -0.009264, -0.001135, 0.002921, 0.000522, -0.004179, -0.007228, -0.009264, -0.019089, -0.025231, -0.031017, -0.049212, -0.071551, -0.092376, -0.115148
#*# 	-0.079746, -0.057514, -0.039064, -0.023180, -0.015005, -0.006211, 0.003560, 0.010631, 0.012649, 0.016680, 0.012649, 0.004942, 0.000708, -0.005193, -0.011113, -0.021136, -0.031017, -0.051283, -0.073645, -0.098342
#*# 	-0.059592, -0.042346, -0.014356, 0.000522, 0.006965, 0.014666, 0.018688, 0.022708, 0.023525, 0.026349, 0.024343, 0.019325, 0.016680, 0.014292, 0.009624, 0.001907, -0.008890, -0.022158, -0.045448, -0.071738
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 450.0
#*# min_y = 50.0
#*# max_y = 400.0
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.3272893657812417,1.7954090561432323,0.7913339865400669,0.28088277726117217,0.7509467091363425,1.134866271936668,-0.7686691360702839,-1.3527392760027173,0.6984822850735924,0.8425585215862923
#*# domain = 3.106092895734782e-07,3.322225989884658e-07
#*# z_offset = 0
#*# reference_temperature = 29.44
#*#
#*# [cartographer touch_model default]
#*# threshold = 2075
#*# speed = 2
#*# z_offset = -0.05
