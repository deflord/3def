

#####################################################################
# Подключаемые модули
#####################################################################
[include mainsail.cfg]
[include timelapse.cfg]            # Конфигурация таймлапсов
[include nozzle_scrub.cfg]          # Очистка сопла
#[include stealthburner_leds.cfg]    # Подсветка StealthBurner
[include offmodule.cfg]             # Модуль включения и выключения
[include led.cfg]                   # Макросы освещения области печати
[include start_end.cfg]             # Макросы начала и окончания печати
[include speed_test.cfg]            # Макрос тестирования скоростей и ускорений
[include K-ShakeTune/*.cfg]         # Макрос для автоматизации измерения графиков InputShaping
[include adxl345.cfg]               # Настройка датчика измерения резонансов


# [scanner]
# canbus_uuid: 228ec44e9470
# #    adjust to suit your scanner, if using usb change to serial.
# #    serial: /dev/serial/by-id/usb-cartographer_cartographer_
# x_offset: 0                          
# #    adjust for your cartographers offset from nozzle to middle of coil
# y_offset: 15                         
# #    adjust for your cartographers offset from nozzle to middle of coil
# backlash_comp: 0.00423
# #   Backlash compensation distance for removing Z backlash before measuring
# #   the sensor response.
# # 
# #   Offsets are measured from the centre of your coil, to the tip of your nozzle 
# #   on a level axis. It is vital that this is accurate. 
# sensor: cartographer
# #    this must be set as cartographer unless using IDM etc.
# sensor_alt: carto
# #    alternate name to call commands. CARTO_TOUCH etc      
# mesh_runs: 2
# #    Number of passes to make during mesh scan.

[mcu cartographer] # See https://www.klipper3d.org/Config_Reference.html#mcu
# Remove either the serial or canbus_uuid line dependant on your setup.
# serial: <blank>
canbus_uuid: 228ec44e9470
# restart_method: command # Not needed for probes using CAN. 
[cartographer]
mcu: cartographer
x_offset: 0 # This is the offset of your probe from the nozzle tip, to the centre of the coil.
y_offset: 15 # This is the offset of your probe from the nozzle tip, to the centre of the coil.
verbose: yes # For extra output






#####################################################################
# 	                          Подключение MCU
#####################################################################
# Подключаем основную плату MKS8
[mcu]
canbus_uuid: 16141ea48a82
# Подключаем CAN плату в голове
# [mcu EBBCan]
# canbus_uuid: 84d7387eb964

#--------------------------------------------------------------------

[virtual_sdcard]
path: ~/printer_data/gcodes         # Путь, указывающий, где будут храниться файлы Gcode
#####################################################################
#                     Контроль температуры MCU
#####################################################################


# Температура хоста (OrangePi)
[temperature_sensor Host]
sensor_type: temperature_host
#sensor_path: /sys/class/thermal/thermal_zone0/temp
min_temp: -50
max_temp: 100

# Температура датчика Cartographer Probe)
[temperature_sensor cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 5
max_temp: 105
#####################################################################
#             Основные настройки кинематики принтера
#####################################################################
[printer]
kinematics: corexy
max_velocity: 400
max_accel: 5000
max_z_velocity: 20
max_z_accel: 350
square_corner_velocity: 5.0



#####################################################################
#                     Настройки оси X
#####################################################################
## Драйвер оси X
[stepper_x]
step_pin: PE5                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  PA8                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PA15                   # PIN Включение двигателя.
rotation_distance: 48               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation:200         # Количество шагов для полного оборота вала двигателя
endstop_pin: PD9                    # PIN, на котором находится концевик оси X
position_min: 0                     # Минимальное положение головы на оси X
position_endstop: 389               # Положение головы, при котором срабатывает концевой выключатель на оси X
position_max: 389                   # Максимальное положение головы на оси X
homing_speed: 180                   # Скорость движения при поиске дома
homing_retract_dist: 5              # Откат (возврат) после нахождения концевого выключателя, в мм.
homing_positive_dir: true           # Направление движения головы по оси X при поиске дома. Если true, голова будет двгигаться к
                                    # к максимальной позиции, если false - к минимальной (в 0)
#--------------------------------------------------------------------
[tmc2209 stepper_x]
uart_pin: PC9                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1.3                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110


#####################################################################
#                  Настройки оси Y
#####################################################################
[stepper_y]
step_pin: PE4                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin: !PC11                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PC12                   # PIN Включение двигателя.
rotation_distance: 48               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
microsteps: 32                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation:200         # Количество шагов для полного оборота вала двигателя
endstop_pin: PD8                    # PIN, на котором находится концевик оси Y
position_min: 0                     # Минимальное положение головы на оси Y
position_endstop: 402              # Положение головы, при котором срабатывает концевой выключатель на оси X
position_max: 402                   # Максимальное положение головы на оси X
homing_speed: 180                   # Скорость движения при поиске дома
homing_retract_dist: 5              # Откат (возврат) после нахождения концевого выключателя, в мм.
homing_positive_dir: true           # Направление движения головы по оси X при поиске дома. Если true, голова будет двгигаться к
                                    # к максимальной позиции, если false - к минимальной (в 0)
#--------------------------------------------------------------------
[tmc2209 stepper_y]
uart_pin: PC10                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 1.3                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110

#####################################################################
#                           Настройки оси Z
#####################################################################
## Двигатель Z0
[stepper_z]
step_pin:  PE3                      # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PD1                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PD2                    # PIN Включение двигателя.
rotation_distance: 37.1296               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
# endstop_pin: sb2209:gpio18        # PIN, на котором находится концевик оси Z
endstop_pin: probe:z_virtual_endstop
position_max: 380                   # Максимальное положение головы на оси Z
position_min: -5                    # Минимальное положение головы на оси Z
homing_speed: 10                    # Скорость движения при поиске дома
second_homing_speed: 3              # Скорость движения при повторном измерении 0 (обычно меньше для увеличения точности)
homing_retract_dist: 0              # Откат (возврат) после нахождения концевого выключателя, в мм.
[tmc2209 stepper_z]
uart_pin:  PD0                      # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
## Двигатель Z1
[stepper_z1]
step_pin: PE2                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin: !PD4                        # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PD5                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z1]
uart_pin: PD3                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
##	Двигатель Z2
[stepper_z2]
step_pin: PE1                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:   !PD7                     # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PB6                    # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z2]
uart_pin: PD6                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
#--------------------------------------------------------------------
##	Двигатель Z3
[stepper_z3]
step_pin: PE0                       # Step GPIO pin (высокий уровень срабатывания). Этот параметр обязателен.
dir_pin:  !PC13                      # Направление вращения двигателя. Этот параметр обязателен.
enable_pin: !PC14                   # PIN Включение двигателя.
rotation_distance: 40               # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 80:16                   # Передаточное число редуктора оси Z
microsteps: 16                      # Количество микрошагов на один шаг двигателя
[tmc2209 stepper_z3]
uart_pin: PB7                       # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.8                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110


#####################################################################
#                    Нагреватель камеры
#####################################################################
[heater_generic chamber_heater]
heater_pin: PD13
sensor_type: EPCOS 100K B57560G104F # Тип датчика температуры
sensor_pin: PC2                     # PIN датчика температуры
#control: pid
#pid_kp: 37.955
#pid_ki: 11.501
#pid_kd: 31.313
max_power: 1.0                      # Максимальная мощность, которую можно подать на нагреватель. 1 соответствует 100% мощности
min_temp: -70                       # Минимальная температура нагревателя. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 120                      # Максимальная температура нагревателя. Если температура превысит данное значения, система выдаст ошибку.

[heater_fan chamber_heater]
pin: PA3                            # PIN управления вентилятором охлаждения нагревателя камеры
max_power: 1.0                      # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
kick_start_time: 0.5                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
                                    # Значение по умолчанию равно 0,100 секунды.
heater: chamber_heater
heater_temp: 60.0                   # Порог запуска вентилятора
fan_speed: 1                        # Позволяет регулировать скорость вентилятора, по умолчанию 1 - 100%
shutdown_speed: 1.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.


[temperature_sensor chamber]
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC3
min_temp: -70
max_temp: 120

#gcode_id:
#   See the "heater_generic" section for the definition of this
#   parameter.
#####################################################################
#                    Настройки хотэнда и экструдера
#####################################################################
[extruder]
step_pin: PE8
dir_pin: !PE12
enable_pin: !PE11
rotation_distance: 39.5801536          # Расстояние (в мм), которое проходит ось при одном полном
                                    # обороте шагового двигателя (или конечной передаче, если указано значение gear_ratio).
                                    # Этот параметр обязателен.
gear_ratio: 9:1                     # Передаточное число редуктора экструдераmicrosteps: 8                      # Количество микрошагов на один шаг двигателя
full_steps_per_rotation: 200        # Количество шагов для полного оборота вала двигателя
microsteps: 8                       # Количество микрошагов на один шаг двигателя
nozzle_diameter: 0.400              # Диаметр сопла, значение по умолчанию 0.4.
filament_diameter: 1.75             # Диаметр используемого пластика
heater_pin: PD12
sensor_type: PT1000
sensor_pin: PC5
min_temp: -20                       # Минимальная температура хотэнда. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 330                       # Максимальная температура хотэнда. Если температура превысит данное значения, система выдаст ошибку.
max_power: 1.0                      # Максимальная мощность, которую можно подать на хотэнд. 1 соответствует 100% мощности
min_extrude_temp: 170               # Минимальная температура, при которой возможна экструзия. Если хотэнд нагрет ниже, система выдаст ошибку и
                                    # мотор экструдера не будет вращаться
max_extrude_only_distance: 200      # Максимальное расстояние в мм, на которое можно выдавить пластик за один раз
max_extrude_cross_section: 50       # Максимальная площадь поперечного сечения экструзии (в мм^2) (например, ширина экструзии, умноженная на высоту слоя).
                                    # Эта настройка предотвращает чрезмерное выдавливание при относительно небольших перемещениях XY.
                                    # Если при перемещении требуется скорость экструзии, превышающая это значение, это приведет к возврату ошибки.
                                    # Значение по умолчанию равно: 4.0 * nozzle_diameter^2

#Для калибровки PID хотэнда выполните команду："PID_CALIBRATE HEATER=extruder TARGET=245"
#control = pid                      # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
#pid_kp = 26.213                    # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
#pid_ki = 1.304                     # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
#pid_kd = 131.721                   # Параметр PID калибровки хотэнда, по умолчанию указывается как комментарий. Руками НЕ ПРАВИТЬ!
pressure_advance: 0.05              # Параметр Pressure Advance, по умочанию 0.05
pressure_advance_smooth_time: 0.040    # Параметр сглаживания Pressure Advance, по умочанию 0.040
[tmc2209 extruder]
uart_pin: PC15             # PIN по которому будет происходить управление драйвером по UART
interpolate: false                  # Для большей точности ставим false
run_current: 0.6                    # Ток двигателя, в мА
sense_resistor: 0.110               # sense resistor моторов в омах, по умолчанию 0.110
driver_TBL: 2
driver_HSTRT: 5
driver_TOFF: 2
driver_HEND: 3            
driver_IHOLDDELAY: 6
stealthchop_threshold: 0 

#[tmc2240 extruder]
#uart_pin: sb2209:gpio15
#interpolate: True
#run_current: 0.55
#rref: 12300
#stealthchop_threshold: 0
#driver_TBL: 2
#driver_HSTRT: 5
#driver_TOFF: 2
#driver_HEND: 3
#driver_IHOLDDELAY: 6
#####################################################################
[verify_heater extruder]            # Проверка нагревателя и датчика температуры.
max_error: 120                      # Максимальная "суммарная температурная погрешность" перед выдачей сообщения об ошибке.
                                    # Меньшие значения приводят к более строгой проверке, а большие значения позволяют увеличить время до
                                    # появления сообщения об ошибке. В частности, температура проверяется раз в секунду, и если
                                    # она близка к заданной температуре, то внутренний "счетчик ошибок" сбрасывается;
                                    # в противном случае, если температура ниже заданного диапазона, то счетчик увеличивается на величину,
                                    # на которую указанная температура отличается от этого диапазона.
                                    # Если значение счетчика превышает значение "max_error", выдается сообщение об ошибке.
                                    # Значение по умолчанию равно 120
check_gain_time:120                 # Это позволяет контролировать проверку нагревателя при первоначальном нагреве.
                                    # Меньшие значения приводят к более тщательной проверке, а большие значения позволяют увеличить время
                                    # до появления сообщения об ошибке. В частности, во время первоначального нагрева,
                                    # если температура нагревателя повышается в течение этого периода времени (указанного в секундах),
                                    # внутренний "счетчик ошибок" сбрасывается.
                                    # Значение по умолчанию равно 20 секундам для экструдеров и 60 секундам для нагревательного слоя.
hysteresis: 50                      # Максимальная разница температур (в градусах Цельсия) с заданной температурой,
                                    # которая считается в пределах заданного диапазона. Это позволяет проверить диапазон max_error.
                                    # Это значение редко настраивается. Значение по умолчанию равно 5.
heating_gain: 2                     # Минимальная температура (в градусах Цельсия), на которую должен быть увеличен нагреватель
                                    # во время проверки check_gain_time. Это значение редко настраивается. Значение по умолчанию равно 2.

#####################################################################
#                   Настройка подогреваемого стола
#####################################################################
[heater_bed]
heater_pin: PB1                     # PIN управления нагревателем стола
sensor_type: EPCOS 100K B57560G104F # Тип датчика температуры
sensor_pin: PB0                     # PIN датчика температуры
max_power: 1.0                      # Максимальная мощность, которую можно подать на стол. 1 соответствует 100% мощности
min_temp: -70                       # Минимальная температура стола. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 133                       # Максимальная температура стола. Если температура превысит данное значения, система выдаст ошибку.
#####################################################################
#                       Вентиляторы охлаждения
#####################################################################

######################### Вентилятор охлаждения хотэнда ########################
[heater_fan Hotend]
pin: PC7               # PIN управления вентилятором охлаждения хотэнда
max_power: 1.0                      # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
kick_start_time: 0.5                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
                                    # Значение по умолчанию равно 0,100 секунды.
heater: extruder
heater_temp: 50.0                   # Порог запуска вентилятора
fan_speed: 1                        # Позволяет регулировать скорость вентилятора, по умолчанию 1 - 100%
shutdown_speed: 1.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.

######################## Вентилятор обдува области печати ########################
[fan]
pin: PD15
enable_pin: PD14
hardware_pwm: False
max_power: 0.5
cycle_time: 0.000022
off_below: 0.15
kick_start_time: 0.01

######################## Вентиляторы Nevermore ########################
[duplicate_pin_override]
pins: PB0, PC3                           # Указываем Klipper, что будем повторно использовать значения PIN температуры подогреваемого стола

[temperature_fan Nevermore Fan]
pin: PC6                           # PIN управления вентиляторами Nevermore
max_power: 1                        # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
shutdown_speed: 0.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.
kick_start_time: 5.0                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
                                    # Значение по умолчанию равно 0,100 секунды.
sensor_type: EPCOS 100K B57560G104F # Тип датчика температуры
sensor_pin:  PB0                    # PIN датчика температуры
min_temp: -70                       # Минимальная температура стола. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 133                       # Максимальная температура стола. Если температура превысит данное значения, система выдаст ошибку.
target_temp: 95                     # Температура, которую будет пытаться достичь Nevermore. Так как мы используем значения температуры стола, то
                                    # по сути это температура стола, при которой будет включаться Nevermore
gcode_id: A
control: watermark



[fan_generic Вытяжка]
pin:PA2
max_power: 1.0

########################  Вентиляторы отсека аппаратуры #########################
[temperature_fan Апп.Отсек Fan]
pin: PA1                            # PIN управления вытяжным вентилятором
max_power: 1                        # Максимальная мощность, которую можно подать на вентилятор. 1 соответствует 100% мощности
shutdown_speed: 0.0                 # Требуемая скорость вращения вентилятора (выраженная в виде значения от 0,0 до 1,0),
                                    # если программное обеспечение микроконтроллера переходит в состояние ошибки. Значение по умолчанию равно 0.
kick_start_time: 1.0                # Время (в секундах), необходимое для запуска вентилятора на полной скорости при
                                    # первом включении или увеличении ее более чем на 50% (помогает запустить вентилятор).
sensor_type: temperature_mcu        # Тип датчика температуры
min_temp: -70                       # Минимальная температура в хост-компьютера. Если температура опуститься ниже данного значения, система выдаст ошибку.
max_temp: 100                       # Максимальная температура в хост-компьютера. Если температура превысит данное значения, система выдаст ошибку.
target_temp: 15                     # Температура хост-компьютера по умолчанию, при достижении которой будет включаться вытяжной вентилятор.
gcode_id: D
control: watermark

#####################################################################
#	          Управление подсветкой печатной камеры
#####################################################################
[neopixel Подсветка]
pin: PA4                            # PIN управления подстветкой
chain_count: 50                     # Количество светодиодов в цепочке подсветки
color_order: GRB                    # Тип светодиодной ленты
initial_RED: 1                      # Первичное значение красного цвета
initial_GREEN: 1                    # Первичное значение зелёного цвета
initial_BLUE: 1                     # Первичное значение синего цвета

#####################################################################
#                          Таймаут принтера
#####################################################################
[idle_timeout]
timeout: 38800                      # Время простоя принтера, при превышении которого принтер сбрасывает текущие задачи. В секундах.
#####################################################################
#             Настройки пробы уровня стола (Euclid)
#####################################################################


#####################################################################
# 	                  Построение карты стола
#####################################################################
[bed_mesh]
speed: 250                          # Скорость перемещения по оси X и Y при построении карты стола
horizontal_move_z: 10               # Высота, на которую будет подниматься ось Z при перемещении для построения карты
mesh_min: 50, 49                    # Точки с минимальными коородинатами x，y которые будет измерены
mesh_max: 350,310                   # Точки с максимальными коородинатами x，y которые будет измерены
fade_start: 0.6                     # На первых слоях голова начинает при своём движении учитывать карту стола и подниматься
                                    # опускаться относительно неё, что бы обеспечить ровные первые слои. Но начиная с
                                    # высоты fade_start принтер начнёт все меньше и меньше учитывать карту стола и плавно
                                    # переходить на ровное движение
fade_end: 10.0                      # Высота, при которой закончиться процесс выравнивания головы отностительно карты стола
fade_target: 0                      # Дополнительное смещение, которое останется после завершения выравнивания
probe_count: 15,15                  # Количество точек сетки стола по осям X и Y
mesh_pps: 2,3                       # Количество точек интерполяции
algorithm: bicubic                  # Алгоритм интерполяции
bicubic_tension: 0.2                # Натяжение интерполяции
zero_reference_position: 200, 200   # Центр измерения сетки

#####################################################################
#                  Настройки выравнивания портала
#####################################################################
[homing_override]
axes: z                             # Ось по которой осуществляется выравнивание
set_position_z: 0                   # Если указано, принтер будет считать, что ось находится в указанном положении до
                                    # выполнения приведенных выше команд с помощью g-кода. Установка этого параметра
                                    # отключает проверку наведения на ось. Это может быть полезно, если перед запуском
                                    # обычного механизма G28 для оси необходимо переместить головку.
                                    # По умолчанию положение оси не задается принудительно.
gcode:
   G90
   G0 Z15 F600
   G28 Y
   {% set y_park = printer.toolhead.axis_maximum.y|float - 15.0 %}
   G0 Y{y_park} F6600
   G28 X
   # {% set x_park = printer.toolhead.axis_maximum.x|float - 15.0 %}
   # G0 X{x_park} F6600
   G0 X194 Y185 F6600
   G28 Z
   G0 Z20 F1800

[quad_gantry_level]                 # Скорость перемещения по оси X и Y при выравнивании портала
gantry_corners:
	-60,-10
	460,470
points:
	50,50
	50,350
	350,350
	350,50
#--------------------------------------------------------------------
speed: 230                          # Скорость, с которой будет перемещаться голова при QGL
horizontal_move_z: 10               # Высота, на которую будет подниматься ось Z при перемещении для выравнивания портала
retry_tolerance: 0.05               # Точность измерения, которая должна быть получена. Если точность ниже, система выдаст ошибку.
retries: 5                          # Количество повторений измерения. Если после заданного количества
                                    # повторений не будет достигнута заданная точность, система выдаст ошибку
max_adjust: 10                      # Количество повторений процесса выравнивания. Если после заданного количества
                                    # повторений не будет достигнута заданная точность, система выдаст ошибку

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
    SAVE_GCODE_STATE NAME=STATE_QGL
    BED_MESH_CLEAR
    {% if not printer.quad_gantry_level.applied %}
    _QUAD_GANTRY_LEVEL horizontal_move_z=10 retry_tolerance=1
    {% endif %}
    _QUAD_GANTRY_LEVEL horizontal_move_z=2 METHOD=rapid_scan ADAPTIVE=1
    # G28 Z
    RESTORE_GCODE_STATE NAME=STATE_QGL


#####################################################################
#            Настройка число-буквенного дисплея 12864mini
#####################################################################
########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_10=<GND>, EXP1_9=<5V>,
    EXP1_8=PE14,   EXP1_7=PA0,
    EXP1_6=PB10,   EXP1_5=PE15,
    EXP1_4=PA14,   EXP1_3=PA13,
    EXP1_2=PB11,   EXP1_1=PE7,

    # EXP1 header
    EXP2_10=<GND>, EXP2_9=<5V>,
    EXP2_8=PE13,   EXP2_7=<RST>,
    EXP2_6=PA10,   EXP2_5=PB15,
    EXP2_4=PA9,    EXP2_3=PB12,
    EXP2_2=PB14,   EXP2_1=PB13,




#####################################################################
#                Настройка движения по кривым
#####################################################################
[gcode_arcs]                        # Подключение механизма движения по кривым линиям
resolution: 0.1                    # Точность при движении по кривым в командах G2，G3
                                    # Кривая будет разделена на несколько сегментов. Длина каждого сегмента будет равна
                                    # указанному разрешению (в мм). Более низкие значения позволят получить более
                                    # точные кривые, но при этом сущетсвенно увеличивают нагрузку на процессор вашего принтера.
                                    # Если дуга меньше заданного значения, она превратится в прямую линию.
                                    # Значение по умолчанию - 0.1 мм.
#####################################################################
#          Возможность исключать объекты во время печати
#####################################################################
[exclude_object]

[firmware_retraction]
retract_length: 0.8
# Длина отката при G10 в мм, а так же длина подачи, возвращаемая при запуске G11
# (но она также включает в себя следующую unretract_extra_length). Значение по умолчанию равно 0 мм.
retract_speed: 35
#  Скорость ретракта в миллиметрах в секунду (мм/с), по умолчанию равна 20 мм/с.
unretract_extra_length: 0
# Дополнительная длина, добавляемая при подаче прутка после ретракта
unretract_speed: 35
# Скорость подачи после ретакта, в мм/с, по умолчанию 10мм/с

[shaketune]
# result_folder: ~/printer_data/config/ShakeTune_results
#    Path where the processed results will be stored. If the folder doesn't exist,
#    it will be automatically created. You can change this if you'd like to store 
#    results in a different location.
# number_of_results_to_keep: 10
#    This setting defines how many results you want to keep in the result folder.
#    Once the specified number is exceeded, older results will be automatically deleted
#    to free up space on the SD card and avoid cluttering the results folder.
# keep_raw_data: False
#    If set to True, Shake&Tune will store both the processed graphs and the raw accelerometer
#    .stdata files in the results folder. This can be useful for debugging or archiving purposes.
#    Please always attach them when reporting any issues on GitHub or Discord.
# show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for system commands (macros that are not part
#    of the printer.cfg file). This option allow Shake&Tune to inject them into the webui at runtime.
#    If set to False, the macros will be hidden but still accessible from the console by typing
#    their names manually, which can be useful if you prefer to encapsulate them into your own macros.
# timeout: 600
#    This defines the maximum processing time (in seconds) to allows to Shake&Tune for generating 
#    graphs from a .stdata file. 10 minutes should be more than enough in most cases, but if you have
#    slower hardware (e.g., older SD cards or low-performance devices), increase it to prevent timeouts.
# measurements_chunk_size: 2
#    Each Shake&Tune command uses the accelerometer to take multiple measurements. By default,
#    Shake&Tune will write a chunk of data to disk every two measurements, and at the end of the
#    command will merge these chunks into the final .stdata file for processing. "2" is a very
#    conservative setting to avoid Klipper Timer Too Close errors on lower end devices with little
#    RAM, and should work for everyone. However, if you are using a powerful computer, you may
#    wish to increase this value to keep more measurements in memory (e.g., 15-20) before writing
#    the chunk and avoid stressing the filesystem too much.
# max_freq: 200
#    This setting defines the maximum frequency at which the calculation of the power spectral density
#    is cutoff. The default value should be fine for most machines and accelerometer combinations and
#    avoid touching it unless you know what you're doing.
# dpi: 300
#    Controls the resolution of the generated graphs. The default value of 300 dpi was optimized
#    and strikes a balance between performance and readability, ensuring that graphs are clear
#    without using too much RAM to generate them. Usually, you shouldn't need to change this value.


#####################################################################
#                     Макрос загрубления температуры
#####################################################################


[gcode_macro M109]
rename_existing: M99109
gcode:
    {% set s = params.S|float %}
    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  ; Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s} MAXIMUM={s+1}   ; Wait for hotend temp (within 1 degree)
    {% endif %}  

#####################################################################
#                     Служебные данные и настройки
#####################################################################

# [include AFC/*.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 57.501
#*# pid_ki = 2.556
#*# pid_kd = 323.441
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 26.563
#*# pid_ki = 3.472
#*# pid_kd = 50.803
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 49.8
#*# shaper_type_y = mzv
#*# shaper_freq_y = 35.2
#*#
#*# [probe]
#*# z_offset = 19.240
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.400
#*# scanner_touch_threshold = 750
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.054441, 0.059760, 0.080151, 0.099500, 0.111671, 0.118630, 0.112239, 0.101553, 0.088436, 0.090476, 0.098424, 0.093469, 0.083497, 0.071096, 0.026617
#*# 	0.054196, 0.046562, 0.064039, 0.078913, 0.105711, 0.103386, 0.089843, 0.086740, 0.068447, 0.056132, 0.062539, 0.084248, 0.086241, 0.082891, 0.038630
#*# 	0.039008, 0.030341, 0.041086, 0.059259, 0.077719, 0.098259, 0.071656, 0.047837, 0.034471, 0.029345, 0.044934, 0.066293, 0.063456, 0.047399, 0.017735
#*# 	0.019337, 0.020348, 0.014884, 0.027742, 0.049722, 0.059301, 0.040972, 0.041751, 0.030702, 0.024339, 0.036846, 0.032509, 0.034929, 0.025879, 0.002147
#*# 	0.003850, 0.005935, -0.001173, 0.008546, 0.020435, 0.020742, 0.021284, 0.028650, 0.024007, 0.033833, 0.031098, 0.019498, 0.011907, 0.004529, -0.012776
#*# 	-0.015675, -0.015853, -0.008704, -0.000327, 0.013869, 0.012014, 0.011115, 0.020678, 0.010704, 0.008150, 0.016063, 0.011504, 0.008255, 0.006350, -0.004808
#*# 	-0.029497, -0.022566, -0.004158, 0.004582, 0.024836, 0.021741, 0.017352, 0.011836, 0.015187, 0.018676, 0.023945, 0.033553, 0.043620, 0.029014, -0.006139
#*# 	-0.034687, -0.033914, -0.000432, 0.010578, 0.026673, 0.023056, 0.015742, 0.009070, -0.005053, 0.012095, 0.024446, 0.023866, 0.019579, 0.009373, -0.009498
#*# 	-0.042707, -0.026620, -0.003894, 0.009849, 0.025560, 0.023684, 0.015160, 0.015596, -0.002326, 0.001816, 0.006719, 0.015678, 0.015419, 0.006047, -0.019593
#*# 	-0.037095, -0.018694, -0.013981, 0.004202, 0.019010, 0.015112, 0.015665, 0.014720, 0.000143, -0.007514, 0.000088, 0.011879, 0.017309, -0.004155, -0.036558
#*# 	-0.031310, -0.024610, -0.004899, 0.012446, 0.019287, 0.025707, 0.019564, 0.019703, 0.004169, 0.004666, 0.027041, 0.038959, 0.046955, 0.025601, -0.015321
#*# 	-0.021259, -0.003259, 0.019129, 0.032770, 0.041401, 0.057109, 0.055704, 0.049989, 0.029915, 0.034032, 0.058061, 0.071512, 0.074825, 0.072555, 0.029437
#*# 	-0.011451, 0.005732, 0.034148, 0.044289, 0.060058, 0.072357, 0.062312, 0.050263, 0.041236, 0.060955, 0.075931, 0.094433, 0.086404, 0.078652, 0.040556
#*# 	0.008959, 0.026469, 0.053899, 0.065308, 0.082900, 0.099601, 0.085866, 0.054139, 0.048731, 0.061909, 0.083695, 0.096096, 0.086371, 0.072888, 0.041737
#*# 	0.032298, 0.046714, 0.081964, 0.105298, 0.098128, 0.103512, 0.093275, 0.063593, 0.060176, 0.071371, 0.099228, 0.108298, 0.096046, 0.080968, 0.048550
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 350.0
#*# min_y = 49.0
#*# max_y = 349.0
#*#
#*# [scanner model default]
#*# model_coef = 1.6748861864418783,
#*# 	2.0254169403084927,
#*# 	0.6435201272362138,
#*# 	-0.013189087450096282,
#*# 	0.5676364201410878,
#*# 	1.249639088170704,
#*# 	-0.5854013149204923,
#*# 	-1.483459850970781,
#*# 	0.34747855805521916,
#*# 	0.6734145513973809
#*# model_domain = 3.2935793420224876e-07,3.335955117317004e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 84.515231
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.3
#*#
#*# [bed_mesh 20.06.2025]
#*# version = 1
#*# points =
#*# 	0.011260, 0.027538, 0.040973, 0.054978, 0.059556, 0.063329, 0.061398, 0.058206, 0.055737, 0.055244, 0.055456, 0.054444, 0.042853, 0.033858, 0.017288
#*# 	0.010760, 0.027273, 0.039497, 0.051374, 0.059222, 0.059288, 0.056611, 0.052983, 0.047268, 0.046374, 0.044303, 0.044244, 0.038174, 0.033442, 0.017798
#*# 	0.007689, 0.022553, 0.037574, 0.048688, 0.054306, 0.051823, 0.046455, 0.044961, 0.039408, 0.038568, 0.036351, 0.036519, 0.030188, 0.024498, 0.009072
#*# 	0.000465, 0.014193, 0.026312, 0.037911, 0.044462, 0.044228, 0.035325, 0.032146, 0.030357, 0.029020, 0.028968, 0.028260, 0.020705, 0.017575, 0.002107
#*# 	-0.011896, 0.003166, 0.013440, 0.024125, 0.032312, 0.028618, 0.020021, 0.015864, 0.012838, 0.014194, 0.013787, 0.014036, 0.009060, 0.005556, -0.009269
#*# 	-0.012622, 0.003744, 0.014915, 0.023434, 0.028968, 0.023098, 0.016139, 0.011533, 0.011233, 0.011755, 0.010265, 0.012409, 0.008191, 0.004305, -0.013801
#*# 	-0.010487, 0.003373, 0.016562, 0.024234, 0.025152, 0.018876, 0.010673, 0.007321, 0.003390, 0.007335, 0.003975, 0.007705, 0.003288, -0.000532, -0.015924
#*# 	-0.011754, 0.003850, 0.013091, 0.018605, 0.018475, 0.014761, 0.006244, 0.001267, -0.002409, -0.002913, -0.004065, -0.003667, -0.003126, -0.005855, -0.018970
#*# 	-0.010433, 0.004041, 0.013978, 0.015890, 0.019579, 0.015826, 0.008572, 0.000892, -0.002941, -0.002691, -0.006806, -0.005233, -0.008940, -0.009981, -0.021997
#*# 	-0.017130, -0.000696, 0.007372, 0.013036, 0.015999, 0.015283, 0.007033, 0.000770, -0.005313, -0.004575, -0.006004, -0.007256, -0.013533, -0.016727, -0.025746
#*# 	-0.020043, -0.005708, 0.006634, 0.011512, 0.015832, 0.015505, 0.011057, 0.003809, -0.002905, -0.001082, -0.004698, -0.006532, -0.013348, -0.015826, -0.025815
#*# 	-0.020754, -0.003845, 0.011693, 0.017584, 0.020485, 0.017698, 0.013509, 0.008468, 0.000360, 0.001977, 0.001337, -0.003249, -0.010336, -0.014610, -0.024908
#*# 	-0.021570, -0.005263, 0.010544, 0.014007, 0.018171, 0.016457, 0.009215, 0.003468, -0.003447, -0.001886, -0.004095, -0.008205, -0.016750, -0.019388, -0.027949
#*# 	-0.017153, 0.000742, 0.016833, 0.022180, 0.027195, 0.025361, 0.017353, 0.012487, 0.007547, 0.011689, 0.006938, 0.003326, -0.004032, -0.007437, -0.018819
#*# 	-0.001225, 0.016087, 0.031353, 0.040550, 0.045394, 0.041299, 0.032978, 0.029402, 0.024534, 0.023263, 0.018997, 0.015701, 0.006488, 0.006332, -0.001495
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 3
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 350.0
#*# min_y = 49.0
#*# max_y = 349.0
#*#
#*# [heater_generic chamber_heater]
#*# control = pid
#*# pid_kp = 21.995
#*# pid_ki = 2.933
#*# pid_kd = 41.240
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.6589025369632309,2.1457956374663407,0.847543734923152,0.344986276158516,0.24616647477834383,0.25830869506424947,-0.07753460306258522,-0.1478913233991016,0.13048773092691532,0.10575220384241896
#*# domain = 3.30907661698737e-07,3.348453571046726e-07
#*# z_offset = 0
#*# reference_temperature = 63.33
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.1.0
#*#
#*# [cartographer touch_model default]
#*# threshold = 550
#*# speed = 2
#*# z_offset = -0.05
#*# software_version = 1.3.3
#*# mcu_version = CARTOGRAPHER 5.1.0
